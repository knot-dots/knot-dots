# Indikatoren-Audit: Meeting-basierte Erkenntnisse & Code-Analyse

**Datum:** 2025-08-13  
**Basis:** Meeting-Zusammenfassung + Codebase-Analyse  
**Team:** Helena, Sebastian 
**Audit-Ziel:** Identifikation von UX-Problemen und technischen Verbesserungspotenzialen

## üéØ Zentrale Problemfelder

### 1. **Navigation & Workflow-Komplexit√§t**

#### Problem (aus Meeting):
- "Navigation zu Indikatoren noch zu verschachtelt"
- "Kontext verliert sich" bei Indikator-Ziel-Bindung  
- "Zu viele Schritte" f√ºr einfache Aufgaben

#### Code-Befund:
```typescript
// Komplexe Tab-Navigation in EditableIndicatorDetailView
let currentTab: IndicatorTab = $derived.by(() => {
  const parseResult = tab.safeParse(paramsFromURL(page.url).get('tab'));
  return parseResult.success ? parseResult.data : tab.enum.all;
});
```

#### Impact:
- **User Journey unterbrochen**: Nutzer verlieren Kontext zwischen Screens
- **Kognitive Belastung**: Zu viele Navigationsschritte f√ºr Standard-Tasks
- **Workflow-Ineffizienz**: Power User werden ausgebremst

### 2. **Bearbeitungsbeschr√§nkungen**

#### Problem (aus Meeting):
- "Benutzer k√∂nnen nur Basisdaten aktualisieren"
- "Nicht die gew√ºnschte Entwicklung in Zielen bearbeiten"
- "Ziele direkt im Indikator anlegen fehlt"

#### Code-Befund:
```typescript
// Nur EditableHistoricalValues in Detail-View
{#if $applicationState.containerDetailView.editable && $ability.can('update', container)}
  <EditableHistoricalValues editable bind:container />
{/if}

// Ziele sind separate Container, nicht direkt bearbeitbar
let overallObjective = $derived(findOverallObjective(container, relatedContainers));
```

#### Impact:
- **Workflow-Bruch**: Umweg √ºber Programme f√ºr Ziel-Erstellung
- **Benutzerfrustration**: Erwartete Funktionen nicht verf√ºgbar  
- **Dateninkonsistenz**: Getrennte Bearbeitung f√ºhrt zu Fehlern

### 3. **Berechnungsprobleme & Zielwerte**

#### Problem (aus Meeting):
- "Zielwerte m√ºssen immer von 0 beginnen"
- "Immer Differenz zur aktuellen Prognose angeben, nicht absolute Zahlen"
- "Aktuelle Implementierung funktioniert nicht f√ºr alle Indikatoren"

#### Code-Befund:
```typescript
// Komplexe Zielwert-Aggregation in IndicatorChart
objectives = findLeafObjectives(relatedContainers.filter(isObjectiveContainer))
  .flatMap(({ payload }) => payload.wantedValues)
  .reduce((accumulator, currentValue) => {
    const groupIndex = accumulator.findIndex(([year]) => currentValue[0] == year);
    return groupIndex > -1
      ? [...accumulator.slice(0, groupIndex), [currentValue[0], currentValue[1] + accumulator[groupIndex][1]], ...]
      : [...accumulator, currentValue];
  }, [])
```

#### Impact:
- **Wissenschaftliche Ungenauigkeit**: Falsche Berechnungsergebnisse m√∂glich
- **Benutzerverwirrung**: Nicht-intuitive Zielwert-Eingabe
- **Datenqualit√§t**: Fehleranf√§llige manuelle Differenz-Berechnungen

### 4. **Interface-Usability**

#### Problem (aus Meeting):
- "Filtereinstellungen zu dumm" bei "gew√ºnschte Entwicklung"
- "Suche f√ºr Indikatoren nicht sinnvoll"
- "Spalten in Tabellen nicht sichtbar wenn deaktiviert"

#### Code-Befund:
```typescript
// Facettierte Filter in IndicatorsOverlay
let facets = $derived(
  computeFacetCount(
    new Map([
      ['indicatorType', new Map(indicatorTypes.options.map((v) => [v as string, 0]))],
      ['indicatorCategory', new Map(indicatorCategories.options.map((v) => [v as string, 0]))],
      // ... weitere statische Filter
    ]),
    containers
  )
);
```

#### Impact:
- **Such-Irrelevanz**: Filter passen nicht zu Nutzer-Kontext
- **Ineffiziente Katalog-Nutzung**: Bekannte Indikatoren schwer findbar
- **UI-Inkonsistenz**: Versteckte Tabellenspalten verwirren

## üõ†Ô∏è Technische Herausforderungen

### Bug: Ma√ünahmenziele-Zuordnung
**Problem**: "Ma√ünahmenziele werden den Zielen statt den Ma√ünahmen zugeordnet"

**Root Cause** (Code-Analyse):
```typescript
// Vermutlich in db.ts Relation-Queries
SELECT DISTINCT(c.*)
FROM container c
JOIN container_relation cr ON c.guid = cr.object
  AND cr.predicate IN ('is-measured-by', 'is-objective-for')
  // M√∂glicherweise falsche Pr√§dikat-Zuordnung
```

### Chart-Komplexit√§t
**Problem**: Wirkungsebenen-Darstellung zu komplex

**Code-Befund**: 150+ Zeilen komplexe Plot-Logic in `IndicatorChart.svelte`
```typescript
let effects = $derived.by(() => {
  // 50 Zeilen komplexe Status-basierte Aggregation
  if (measure?.payload.status == status.enum['status.done']) {
    return c.payload.achievedValues.map([year, value]) => ({...});
  } else if (measure?.payload.status == status.enum['status.in_implementation']) {
    // Weitere komplexe Berechnungen
  }
});
```

## üìã N√§chste Schritte - Implementierungsplan

### üî• **Kritisch (Helena + Stefan)**

#### 1. **Direkte Ziel-Erstellung aus Indikator**
```typescript
// Neue Funktion in IndicatorDetailView
function createObjectiveFromIndicator(indicator: IndicatorContainer) {
  const objective = containerOfType('objective', indicator.organization, ...);
  objective.relation.push({
    predicate: 'is-objective-for',
    object: indicator.guid
  });
}
```

#### 2. **Bug-Fix: Ma√ünahmenziele-Zuordnung**  
```sql
-- Korrektur in db.ts Relations-Query
WHERE cr.predicate = 'is-part-of-measure'  -- statt 'is-part-of'
  AND parent.payload.type = 'measure'
```

#### 3. **Absolute Zielwerte erm√∂glichen**
```typescript
// Erweiterte Objective-Logik
const objectivePayload = basePayload.extend({
  wantedValues: z.array(z.tuple([z.number().int().positive(), z.number()])),
  calculationMode: z.enum(['absolute', 'differential']).default('absolute')
});
```

### üü° **Wichtig (UX-Team)**

#### 4. **Navigation vereinfachen**
- **Kontext-persistente Overlays**: Ziel-Erstellung ohne Seitenwechsel
- **Querverweise-Buttons**: Direkte Navigation zwischen Indikator ‚Üî Ziel ‚Üî Ma√ünahme
- **Breadcrumb-Navigation**: Aktueller Kontext immer sichtbar

#### 5. **Intelligente Filter**
```typescript
// Kontext-bewusste Filter-Vorauswahl
function getContextualFilters(indicator: IndicatorContainer, context: 'goals' | 'measures') {
  return {
    indicatorCategory: indicator.payload.indicatorCategory,
    topic: indicator.payload.topic,
    organizationalUnit: indicator.organizational_unit
  };
}
```

#### 6. **Dashboard-√§hnliche Indikator-Detailseite**
```svelte
<!-- Neue Layout-Struktur -->
<IndicatorDashboard>
  <IndicatorKPIs />
  <RelatedGoalsSection editable />
  <RelatedMeasuresSection editable />
  <HistoricalDataSection editable />
</IndicatorDashboard>
```

### üü¢ **Mittelfristig (Sebastian + Team)**

#### 7. **Berechnungsmodell dokumentieren & vereinheitlichen**
```typescript
// Neue Abstraktions-Schicht
class IndicatorCalculationEngine {
  calculateTrend(historicalValues: [number, number][]): TrendData
  calculateObjectiveProgress(current: number, target: number): ProgressData
  aggregateEffects(effects: EffectData[]): AggregatedEffects
}
```

#### 8. **Linien-basierte Darstellung (statt Kacheln)**
```svelte
<!-- Neue Darstellungskomponente -->
<IndicatorLineView>
  <IndicatorHeader />
  <GoalsRow />
  <MeasuresRow />
  <DataRow />
</IndicatorLineView>
```

#### 9. **PNK-Projekt Integration**
- Sektorale Indikatoren-Unterst√ºtzung
- Ist-Daten-fokussierte Workflows  
- Vereinfachte Darstellung ohne Komplexit√§ts-Overhead

## üéØ User Stories (Priorisiert)

### **Epic 1: Vereinfachte Ziel-Indikator-Verkn√ºpfung**
```gherkin
Als kommunaler Nachhaltigkeitsmanager
M√∂chte ich direkt aus einem Indikator heraus ein Ziel erstellen
Damit der Workflow effizienter wird und ich den Kontext nicht verliere

Akzeptanzkriterien:
- Button "Ziel erstellen" in Indikator-Detail-View
- Automatische is-objective-for Relation
- Kontext-erhaltende Overlay-Navigation
```

### **Epic 2: Absolute Zielwerte**  
```gherkin
Als Fachkraft f√ºr Klimaschutz
M√∂chte ich absolute Zielwerte (z.B. "1000 Tonnen CO2 bis 2030") eingeben
Statt immer Differenzen zur aktuellen Prognose berechnen zu m√ºssen

Akzeptanzkriterien:
- Toggle zwischen "Absolut" und "Differenziell"
- Automatische Baseline-Berechnung im Hintergrund
- Klare Anzeige des gew√§hlten Modus
```

### **Epic 3: Power-User Tabellenansicht**
```gherkin
Als erfahrener Tool-Nutzer  
M√∂chte ich alle Indikator-Daten in einer bearbeitbaren Tabelle verwalten
Damit ich effizient Bulk-Operationen durchf√ºhren kann

Akzeptanzkriterien:
- Inline-Editing f√ºr historische Werte
- Bulk-Import/Export Funktionalit√§t
- Immer sichtbare Spalten auch bei Deaktivierung
```

## üîç Code-Verbesserungen

### Architektur-Refactoring
1. **Separation of Concerns**: Chart-Logic aus Components in Services
2. **Business Logic Abstraktion**: CalculationEngine f√ºr komplexe Berechnungen
3. **State Management**: Bessere Reaktivit√§t zwischen verkn√ºpften Containern

### Performance-Optimierungen
1. **Lazy Loading**: Charts nur bei Bedarf rendern
2. **Memoization**: Teure Aggregations-Berechnungen cachen  
3. **Virtual Scrolling**: F√ºr gro√üe Indikator-Listen

### Test-Coverage
1. **Unit Tests**: Berechnungslogik isoliert testen
2. **Integration Tests**: Relation-Queries validieren
3. **E2E Tests**: Kritische User-Workflows absichern

## üéØ Erfolgsmessung

### Quantitative Metriken
- **Task-Completion-Time**: Ziel-Indikator-Verkn√ºpfung < 30 Sekunden
- **Error-Rate**: Berechnungsfehler < 1%  
- **User-Satisfaction**: SUS-Score > 80

### Qualitative Indikatoren  
- **Kontext-Erhaltung**: Nutzer verlieren seltener den √úberblick
- **Workflow-Effizienz**: Weniger Support-Tickets zu Navigation
- **Feature-Adoption**: Neue Funktionen werden aktiv genutzt

---

**Fazit:** Das Meeting best√§tigt die Code-Analyse - technisch solide Basis, aber UX-seitig signifikanter Verbesserungsbedarf. Die priorisierten Ma√ünahmen adressieren die kritischsten Workflow-Probleme und schaffen die Grundlage f√ºr bessere Benutzerfreundlichkeit.