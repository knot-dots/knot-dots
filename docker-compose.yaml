services:
  app:
    build:
      context: app
      target: dev
    depends_on:
      elasticsearch:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
      storage:
        condition: service_started
    env_file:
      - ./db/.env
      - ./app/.env
    environment:
      - ROARR_LOG=true
    ports:
      - "5173:5173"
    volumes:
      - ./app/src:/srv/app/src

  db:
    build:
      context: db
    env_file:
      - ./db/.env
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_USER}" ]
      interval: 3s
      timeout: 3s
      retries: 3
      start_period: 10s
    volumes:
      - ./db/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d

  import:
    build:
      context: .
      dockerfile: import/Dockerfile
    depends_on:
      db:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    env_file:
      - ./db/.env
      - ./app/.env
    environment:
      - DE_LABELS_PATH=/opt/labels/de.json
      - ROARR_LOG=true
    profiles:
      - import
    volumes:
      - ./import/src:/srv/app/src
      - ./shared:/srv/app/shared
      - ./app/src/lib/locales/de.json:/opt/labels/de.json:ro

  migrate:
    build:
      context: migrate
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ./db/.env
      - ./app/.env
    volumes:
      - ./migrate/sql:/srv/migrations
    working_dir: /srv/migrations

  keycloak:
    command:
      - start-dev
      - --import-realm
      - --log-console-output=json
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ./keycloak/.env
    healthcheck:
      test: [ "CMD-SHELL", "printf '' 2>>/dev/null >>/dev/tcp/localhost/8080" ]
      interval: 3s
      timeout: 3s
      retries: 20
    image: quay.io/keycloak/keycloak:25.0.2
    ports:
      - "8080:8080"
    volumes:
      - ./keycloak/import:/opt/keycloak/data/import
      - ./keycloak/themes:/opt/keycloak/themes

  elasticmq:
    image: softwaremill/elasticmq-native
    ports:
      - "9324:9324"
      - "9325:9325"
    volumes:
      - ./elasticmq.conf:/opt/elasticmq.conf
    environment:
      - CONFIG_FILE=/opt/elasticmq.conf

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:9.2.3
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - node.name=es01
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "9200:9200"

  indexing-worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    depends_on:
      elasticsearch:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
      db:
        condition: service_healthy
    env_file:
      - ./db/.env
      - ./app/.env
    environment:
      - INDEXING_WORKER_POLL_INTERVAL_MS=2000
      - DE_LABELS_PATH=/opt/labels/de.json
      - ROARR_LOG=true
    volumes:
      - ./shared:/srv/app/shared
      - ./app/src/lib/locales/de.json:/opt/labels/de.json:ro
    healthcheck:
      test: ["CMD-SHELL", "ps -o pid= 1 >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  preview:
    # Use the variable TEST_IMAGE if provided, otherwise build locally
    image: ${TEST_IMAGE:-preview-local}
    build:
      context: app
      target: production
    depends_on:
      keycloak:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    env_file:
      - ./db/.env
      - ./app/.env
    environment:
      - PUBLIC_BASE_URL=http://localhost:3000
      - ORIGIN=http://localhost:3000
    ports:
      - "3000:3000"
    profiles:
      - qa

  smtp:
    image: axllent/mailpit
    ports:
      - "8081:8025"

  storage:
    environment:
      COM_ADOBE_TESTING_S3MOCK_STORE_INITIAL_BUCKETS: upload
    hostname: upload.storage
    image: adobe/s3mock
    ports:
      - "8082:9090"
