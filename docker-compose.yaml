services:
  app:
    build:
      context: app
      target: dev
    depends_on:
      keycloak:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    env_file:
      - ./db/.env
      - ./app/.env
    ports:
      - "5173:5173"
    volumes:
      - ./app/src:/srv/app/src
  composer:
    build:
      context: drupal
      target: builder
    volumes:
      - ./drupal:/srv/app
      - ~/.composer:/tmp
  db:
    env_file:
      - ./db/.env
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U dev" ]
      interval: 3s
      timeout: 3s
      retries: 3
    image: postgres:14
  drupal:
    build:
      context: drupal
    command:
      - "/usr/sbin/apache2ctl"
      - "-DFOREGROUND"
    depends_on:
      db:
        condition: service_healthy
      smtp:
        condition: service_started
    entrypoint:
      - "docker-entrypoint.sh"
    env_file:
      - ./db/.env
      - ./drupal/.env
    ports:
      - "8000:8000"
    volumes:
      - ./drupal/config:/srv/app/config
      - ./drupal/vendor:/srv/app/vendor
      - ./drupal/web/modules:/srv/app/web/modules:cached
      - ./drupal/web/profiles:/srv/app/web/profiles:cached
      - ./drupal/web/sites:/srv/app/web/sites:ro,cached
      - public-files:/srv/app/web/files
  migrate:
    build:
      context: migrate
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ./db/.env
      - ./app/.env
    volumes:
      - ./migrate/sql:/srv/migrations
    working_dir: /srv/migrations
  keycloak:
    command:
      - start-dev
      - --import-realm
      - --log-console-output=json
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    healthcheck:
      test: [ "CMD-SHELL", "printf '' 2>>/dev/null >>/dev/tcp/localhost/8080" ]
      interval: 3s
      timeout: 3s
      retries: 20
    image: quay.io/keycloak/keycloak:25.0.2
    ports:
      - "8080:8080"
    volumes:
      - ./keycloak/import:/opt/keycloak/data/import
      - ./keycloak/themes:/opt/keycloak/themes
  preview:
    build:
      context: app
      target: production
    depends_on:
      keycloak:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    env_file:
      - ./db/.env
      - ./app/.env
    environment:
      - PUBLIC_BASE_URL=http://localhost:3000
    ports:
      - "3000:3000"
    profiles:
      - qa
  smtp:
    environment:
      ServerOptions__AuthenticationRequired: true
      ServerOptions__SmtpAllowAnyCredentials: true
    image: rnwood/smtp4dev
    ports:
      - "8081:80"
volumes:
  public-files:
